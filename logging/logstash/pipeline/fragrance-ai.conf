# ğŸ”¥ Logstash íŒŒì´í”„ë¼ì¸ ì„¤ì • - Fragrance AI
input {
  # íŒŒì¼ì—ì„œ ë¡œê·¸ ì½ê¸°
  file {
    path => "/logs/fragrance-ai/*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["fragrance-ai", "application"]
  }

  # JSON Lines í˜•ì‹ ë¡œê·¸
  file {
    path => "/logs/fragrance-ai/*.jsonl"
    start_position => "beginning"
    codec => "json_lines"
    tags => ["fragrance-ai", "structured"]
  }

  # Docker ë¡œê·¸
  file {
    path => "/var/log/containers/fragrance-ai*.log"
    start_position => "beginning"
    codec => "json"
    tags => ["fragrance-ai", "docker"]
  }

  # Redisë¥¼ í†µí•œ ì‹¤ì‹œê°„ ë¡œê·¸ ìŠ¤íŠ¸ë¦¼
  redis {
    host => "redis"
    port => 6379
    key => "fragrance-ai:logs"
    data_type => "list"
    codec => "json"
    tags => ["fragrance-ai", "realtime"]
  }

  # Beats ì…ë ¥ (Filebeat, Metricbeat ë“±)
  beats {
    port => 5044
    tags => ["fragrance-ai", "beats"]
  }

  # HTTP ì—”ë“œí¬ì¸íŠ¸ (ì›¹í›…)
  http {
    port => 8080
    codec => "json"
    tags => ["fragrance-ai", "webhook"]
  }
}

filter {
  # Fragrance AI ë¡œê·¸ë§Œ ì²˜ë¦¬
  if "fragrance-ai" in [tags] {

    # íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹±
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }

    # ë¡œê·¸ ë ˆë²¨ ì •ê·œí™”
    if [level] {
      mutate {
        uppercase => [ "level" ]
      }
    }

    # IP ì£¼ì†Œ GeoIP ì¡°íšŒ
    if [client_ip] {
      geoip {
        source => "client_ip"
        target => "geoip"
      }
    }

    # ì‚¬ìš©ì ì—ì´ì „íŠ¸ íŒŒì‹±
    if [user_agent] {
      useragent {
        source => "user_agent"
        target => "ua"
      }
    }

    # ì—ëŸ¬ ë©”ì‹œì§€ ë¶„ë¥˜
    if [error] {
      if [error][type] {
        mutate {
          add_field => { "error_category" => "%{[error][type]}" }
        }
      }

      # ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ ì¤„ë°”ê¿ˆ ì •ë¦¬
      if [error][traceback] {
        mutate {
          gsub => [ "[error][traceback]", "\n", " | " ]
        }
      }
    }

    # API ì—”ë“œí¬ì¸íŠ¸ ì •ê·œí™”
    if [endpoint] {
      # IDë‚˜ UUID íŒ¨í„´ì„ ì¼ë°˜í™”
      mutate {
        gsub => [
          "endpoint", "/\d+", "/{id}",
          "endpoint", "/[a-f0-9\-]{36}", "/{uuid}",
          "endpoint", "/[a-f0-9]{32}", "/{hash}"
        ]
      }
    }

    # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¶„ë¥˜
    if [metrics] {
      if [metrics][response_time_ms] {
        if [metrics][response_time_ms] > 2000 {
          mutate {
            add_field => { "performance_category" => "slow" }
          }
        } else if [metrics][response_time_ms] > 1000 {
          mutate {
            add_field => { "performance_category" => "medium" }
          }
        } else {
          mutate {
            add_field => { "performance_category" => "fast" }
          }
        }
      }
    }

    # ë³´ì•ˆ ì´ë²¤íŠ¸ ê°ì§€
    if [category] == "security" {
      mutate {
        add_field => { "alert_priority" => "high" }
      }

      # SQL ì¸ì ì…˜ íŒ¨í„´ ê°ì§€
      if [message] =~ /(?i)(union|select|insert|update|delete|drop|create|alter|exec|script|<script|javascript:)/ {
        mutate {
          add_field => { "security_threat" => "sql_injection_or_xss" }
        }
      }

      # ë¸Œë£¨íŠ¸ í¬ìŠ¤ ê³µê²© ê°ì§€
      if [event_type] == "failed_login" {
        mutate {
          add_field => { "security_threat" => "brute_force" }
        }
      }
    }

    # ì‚¬ìš©ì ì„¸ì…˜ ì •ë³´ ì¶”ê°€
    if [context] and [context][user_id] {
      mutate {
        add_field => { "user_id" => "%{[context][user_id]}" }
      }
    }

    # ì„œë¹„ìŠ¤ ì •ë³´ ë³´ê°•
    mutate {
      add_field => {
        "service_name" => "fragrance-ai"
        "service_version" => "2.0.0"
        "log_source" => "logstash"
      }
    }

    # í™˜ê²½ ì •ë³´ ì¶”ê°€
    if [context] and [context][environment] {
      mutate {
        add_field => { "environment" => "%{[context][environment]}" }
      }
    } else {
      mutate {
        add_field => { "environment" => "production" }
      }
    }

    # ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±°
    mutate {
      remove_field => [ "host", "path", "@version" ]
    }

    # ì¤‘ìš”ë„ ì ìˆ˜ ê³„ì‚°
    ruby {
      code => "
        score = 0

        # ë ˆë²¨ì— ë”°ë¥¸ ì ìˆ˜
        case event.get('level')
        when 'CRITICAL'
          score += 100
        when 'ERROR'
          score += 70
        when 'WARNING'
          score += 40
        when 'INFO'
          score += 10
        end

        # ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ ì ìˆ˜
        case event.get('category')
        when 'security'
          score += 50
        when 'performance'
          score += 30
        when 'api'
          score += 20
        end

        # ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ì¶”ê°€ ì ìˆ˜
        if event.get('error')
          score += 30
        end

        event.set('importance_score', score)
      "
    }
  }

  # Docker ë¡œê·¸ íŠ¹ë³„ ì²˜ë¦¬
  if "docker" in [tags] {
    # ì»¨í…Œì´ë„ˆ ì •ë³´ ì¶”ì¶œ
    grok {
      match => { "path" => "/var/log/containers/%{DATA:pod_name}_%{DATA:namespace}_%{DATA:container_name}-%{DATA:container_id}.log" }
    }
  }

  # ì—ëŸ¬ ë¡œê·¸ ì•Œë¦¼ ì¡°ê±´
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_field => { "needs_alert" => "true" }
    }
  }

  # ì§€ì—° ì‹œê°„ ì„ê³„ê°’ ì´ˆê³¼ ì•Œë¦¼
  if [metrics] and [metrics][response_time_ms] and [metrics][response_time_ms] > 5000 {
    mutate {
      add_field => { "needs_alert" => "true" }
      add_field => { "alert_reason" => "high_response_time" }
    }
  }
}

output {
  # Elasticsearch ì¸ë±ìŠ¤ë³„ ë¶„ê¸°
  if "fragrance-ai" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "fragrance-ai-logs-%{+YYYY.MM.dd}"
      template_name => "fragrance-ai"
      template => "/etc/logstash/templates/fragrance-ai-template.json"
      template_overwrite => true
    }

    # ì—ëŸ¬ ë¡œê·¸ëŠ” ë³„ë„ ì¸ë±ìŠ¤
    if [level] == "ERROR" or [level] == "CRITICAL" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "fragrance-ai-errors-%{+YYYY.MM.dd}"
      }
    }

    # ë³´ì•ˆ ì´ë²¤íŠ¸ëŠ” ë³„ë„ ì¸ë±ìŠ¤
    if [category] == "security" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "fragrance-ai-security-%{+YYYY.MM.dd}"
      }
    }

    # ì„±ëŠ¥ ë¡œê·¸ëŠ” ë³„ë„ ì¸ë±ìŠ¤
    if [category] == "performance" {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        index => "fragrance-ai-performance-%{+YYYY.MM.dd}"
      }
    }
  }

  # ì‹¤ì‹œê°„ ì•Œë¦¼ì´ í•„ìš”í•œ ê²½ìš°
  if [needs_alert] == "true" {
    # Slack ì›¹í›…
    http {
      url => "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
      http_method => "post"
      format => "json"
      content_type => "application/json"
      mapping => {
        "text" => "ğŸš¨ Fragrance AI ì•Œë¦¼: %{message}"
        "channel" => "#alerts"
        "username" => "LogstashBot"
        "icon_emoji" => ":warning:"
        "attachments" => [
          {
            "color" => "danger"
            "fields" => [
              {
                "title" => "ë ˆë²¨"
                "value" => "%{level}"
                "short" => true
              },
              {
                "title" => "ì¹´í…Œê³ ë¦¬"
                "value" => "%{category}"
                "short" => true
              },
              {
                "title" => "ì‹œê°„"
                "value" => "%{@timestamp}"
                "short" => true
              },
              {
                "title" => "ì„œë¹„ìŠ¤"
                "value" => "%{service_name}"
                "short" => true
              }
            ]
          }
        ]
      }
    }

    # PagerDuty í†µí•© (ì¤‘ìš”í•œ ì•Œë¦¼)
    if [importance_score] and [importance_score] > 80 {
      http {
        url => "https://events.pagerduty.com/v2/enqueue"
        http_method => "post"
        format => "json"
        headers => {
          "Authorization" => "Token token=YOUR_PAGERDUTY_TOKEN"
        }
        mapping => {
          "routing_key" => "YOUR_INTEGRATION_KEY"
          "event_action" => "trigger"
          "payload" => {
            "summary" => "Fragrance AI ì¤‘ìš” ì•Œë¦¼: %{message}"
            "source" => "%{service_name}"
            "severity" => "critical"
            "component" => "%{category}"
            "group" => "fragrance-ai"
            "class" => "%{level}"
            "custom_details" => {
              "timestamp" => "%{@timestamp}"
              "environment" => "%{environment}"
              "error_type" => "%{[error][type]}"
              "importance_score" => "%{importance_score}"
            }
          }
        }
      }
    }

    # Discord ì›¹í›… (ì„ íƒì‚¬í•­)
    http {
      url => "https://discord.com/api/webhooks/YOUR/DISCORD/WEBHOOK"
      http_method => "post"
      format => "json"
      content_type => "application/json"
      mapping => {
        "content" => "ğŸš¨ **Fragrance AI ì•Œë¦¼**\n**ë©”ì‹œì§€**: %{message}\n**ë ˆë²¨**: %{level}\n**ì¹´í…Œê³ ë¦¬**: %{category}\n**ì‹œê°„**: %{@timestamp}"
        "username" => "Fragrance AI Bot"
        "avatar_url" => "https://example.com/bot-avatar.png"
      }
    }
  }

  # ë””ë²„ê·¸ ì¶œë ¥ (ê°œë°œ í™˜ê²½)
  if [environment] == "development" {
    stdout {
      codec => rubydebug
    }
  }

  # ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ InfluxDBë¡œ ì „ì†¡
  if [metrics] {
    influxdb {
      host => "influxdb"
      port => 8086
      database => "fragrance_ai_metrics"
      measurement => "application_metrics"
      send_as_tags => ["level", "category", "service_name", "environment"]
    }
  }

  # íŒŒì¼ ë°±ì—… (ë¡œì»¬ ì €ì¥ì†Œ)
  file {
    path => "/backup/logs/fragrance-ai-%{+YYYY-MM-dd}.log"
    codec => "json_lines"
  }
}

# ë¡œê·¸ íŒŒì´í”„ë¼ì¸ ëª¨ë‹ˆí„°ë§
monitoring {
  enabled => true
  collection_interval => "1s"
  collection_timeout_interval => "10s"
}