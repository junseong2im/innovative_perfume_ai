name: ğŸ” Enhanced Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ 02:00 UTCì— ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ğŸ” ê³ ê¸‰ ì½”ë“œ í’ˆì§ˆ ë¶„ì„
  advanced-code-analysis:
    name: ğŸ” Advanced Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install analysis tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

        # ì¶”ê°€ ë¶„ì„ ë„êµ¬
        pip install \
          vulture \
          xenon \
          dlint \
          semgrep \
          pyupgrade \
          autoflake \
          pydocstyle \
          darglint

    - name: ğŸ“Š Code Complexity Analysis
      run: |
        echo "=== Cyclomatic Complexity Analysis ==="
        radon cc fragrance_ai/ -a -nc --total-average

        echo "=== Maintainability Index ==="
        radon mi fragrance_ai/ -nc

        echo "=== Halstead Metrics ==="
        radon hal fragrance_ai/ -f

    - name: ğŸ§¹ Dead Code Detection
      run: |
        echo "=== Dead Code Detection ==="
        vulture fragrance_ai/ --min-confidence 80

    - name: ğŸ“ Documentation Quality
      run: |
        echo "=== Docstring Analysis ==="
        pydocstyle fragrance_ai/ --convention=google

        echo "=== Argument Documentation Check ==="
        darglint fragrance_ai/ -v 2

    - name: ğŸ”§ Code Modernization Check
      run: |
        echo "=== Python Version Compatibility ==="
        pyupgrade --py310-plus fragrance_ai/**/*.py --diff

        echo "=== Unused Imports ==="
        autoflake --check --remove-all-unused-imports fragrance_ai/

    - name: ğŸ›¡ï¸ Static Analysis Security Testing (SAST)
      run: |
        echo "=== Semgrep Security Scan ==="
        semgrep --config=auto fragrance_ai/ --json --output=semgrep-results.json

        echo "=== Django-specific Linting ==="
        dlint fragrance_ai/ || true

    - name: ğŸ“‹ Upload Code Analysis Results
      uses: actions/upload-artifact@v3
      with:
        name: code-analysis-results
        path: |
          semgrep-results.json
          *.html
          *.xml

  # ğŸ”’ ì‹¬í™” ë³´ì•ˆ ìŠ¤ìºë‹
  comprehensive-security-scan:
    name: ğŸ”’ Comprehensive Security Scanning
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

        # ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
        pip install \
          safety \
          bandit[toml] \
          pip-audit \
          cyclonedx-bom \
          detect-secrets

    - name: ğŸ” Dependency Vulnerability Scan
      run: |
        echo "=== Safety Check ==="
        safety check --json --output safety-report.json || true

        echo "=== Pip Audit ==="
        pip-audit --format=json --output=pip-audit-report.json || true

        echo "=== Generate Software Bill of Materials ==="
        cyclonedx-py -o sbom.json

    - name: ğŸ›¡ï¸ Source Code Security Scan
      run: |
        echo "=== Bandit Security Scan ==="
        bandit -r fragrance_ai/ \
          -f json \
          -o bandit-report.json \
          -ll \
          --confidence-level medium

        echo "=== Configuration File Security ==="
        bandit -r . \
          -f json \
          -o config-security-report.json \
          --skip-dirs=.git,node_modules,venv \
          --include="*.yml,*.yaml,*.json,*.toml,*.ini,*.cfg"

    - name: ğŸ” Secrets Detection
      run: |
        echo "=== Secrets Baseline Update ==="
        detect-secrets scan --all-files \
          --baseline .secrets.baseline \
          --exclude-files '.*\.git/.*|.*node_modules/.*|.*venv/.*'

        echo "=== Secrets Audit ==="
        detect-secrets audit .secrets.baseline

    - name: ğŸ—ï¸ Container Security Scan
      run: |
        echo "=== Dockerfile Security ==="
        docker run --rm -i hadolint/hadolint < Dockerfile || true
        docker run --rm -i hadolint/hadolint < Dockerfile.production || true

    - name: ğŸ“‹ Upload Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          *-report.json
          sbom.json
          .secrets.baseline

  # ğŸ”¬ ë¼ì´ì„¼ìŠ¤ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì‚¬
  license-compliance:
    name: ğŸ”¬ License & Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install compliance tools
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pip-licenses licensecheck

    - name: ğŸ“„ License Analysis
      run: |
        echo "=== Package License Report ==="
        pip-licenses --format=json --output-file=licenses.json

        echo "=== License Compatibility Check ==="
        pip-licenses --format=csv --output-file=licenses.csv

        echo "=== Detailed License Information ==="
        pip-licenses --format=html --output-file=licenses.html

    - name: âš–ï¸ License Policy Check
      run: |
        echo "=== Forbidden License Check ==="
        # GPL, AGPL ë“± ì œí•œì  ë¼ì´ì„¼ìŠ¤ í™•ì¸
        pip-licenses --packages $(pip freeze | cut -d'=' -f1) \
          --ignore-packages $(echo "pip setuptools wheel" | tr ' ' '\n') \
          --fail-on GPL-3.0 AGPL-3.0 || true

    - name: ğŸ“‹ Upload License Reports
      uses: actions/upload-artifact@v3
      with:
        name: license-reports
        path: |
          licenses.*

  # ğŸ—ï¸ Infrastructure as Code Security
  iac-security:
    name: ğŸ—ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Terraform Security Scan
      if: hashFiles('**/*.tf') != ''
      uses: aquasecurity/tfsec-action@v1.0.3
      with:
        additional_args: --format json --out tfsec-results.json

    - name: â˜¸ï¸ Kubernetes Security Scan
      if: hashFiles('**/*.yaml', '**/k8s/**', '**/kubernetes/**') != ''
      run: |
        # Kubesec ì„¤ì¹˜ ë° ì‹¤í–‰
        wget https://github.com/controlplaneio/kubesec/releases/latest/download/kubesec_linux_amd64.tar.gz
        tar -xzf kubesec_linux_amd64.tar.gz

        # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìŠ¤ìº”
        find . -name "*.yaml" -path "*/k8s/*" -o -path "*/kubernetes/*" | \
          xargs -I {} ./kubesec scan {} > kubesec-results.json

    - name: ğŸ³ Docker Security Best Practices
      run: |
        echo "=== Dockerfile Security ==="
        if [ -f "Dockerfile" ]; then
          docker run --rm -i hadolint/hadolint:latest < Dockerfile > dockerfile-lint.txt || true
        fi

        if [ -f "Dockerfile.production" ]; then
          docker run --rm -i hadolint/hadolint:latest < Dockerfile.production > dockerfile-prod-lint.txt || true
        fi

    - name: ğŸ“‹ Upload IaC Security Reports
      uses: actions/upload-artifact@v3
      with:
        name: iac-security-reports
        path: |
          *-results.json
          *-lint.txt

  # ğŸ”„ Supply Chain Security
  supply-chain-security:
    name: ğŸ”„ Supply Chain Security
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ” Package Integrity Check
      run: |
        python -m pip install --upgrade pip

        echo "=== Requirements File Analysis ==="
        # requirements.txtì— ë²„ì „ í•€ë‹ í™•ì¸
        python -c "
        import re
        with open('requirements.txt', 'r') as f:
            lines = f.readlines()

        unpinned = []
        for line in lines:
            line = line.strip()
            if line and not line.startswith('#'):
                if not re.search(r'[=><]', line):
                    unpinned.append(line)

        if unpinned:
            print('Unpinned dependencies found:')
            for dep in unpinned:
                print(f'  - {dep}')
            exit(1)
        else:
            print('All dependencies are properly pinned')
        "

    - name: ğŸ·ï¸ Dependency Provenance
      run: |
        pip install cyclonedx-bom

        echo "=== Generate SBOM ==="
        cyclonedx-py \
          --output-format json \
          --output-file sbom-detailed.json \
          --include-dev

    - name: ğŸ” Digital Signature Verification
      run: |
        echo "=== Package Signature Check ==="
        # PyPI íŒ¨í‚¤ì§€ì˜ í•´ì‹œ ê²€ì¦
        pip download --no-deps -r requirements.txt -d temp_packages/
        find temp_packages/ -name "*.whl" -o -name "*.tar.gz" | \
          xargs -I {} sh -c 'echo "File: {}" && sha256sum {}'

    - name: ğŸ“‹ Upload Supply Chain Reports
      uses: actions/upload-artifact@v3
      with:
        name: supply-chain-reports
        path: |
          sbom-detailed.json
          temp_packages/

  # ğŸ“Š ì¢…í•© ë³´ì•ˆ ë¦¬í¬íŠ¸
  security-summary:
    name: ğŸ“Š Security Summary Report
    runs-on: ubuntu-latest
    needs: [
      advanced-code-analysis,
      comprehensive-security-scan,
      license-compliance,
      iac-security,
      supply-chain-security
    ]
    if: always()

    steps:
    - name: ğŸ“¥ Download all artifacts
      uses: actions/download-artifact@v3

    - name: ğŸ“Š Generate Security Dashboard
      run: |
        echo "# ğŸ” Security Analysis Summary" > security-summary.md
        echo "" >> security-summary.md
        echo "## ğŸ“‹ Analysis Results" >> security-summary.md
        echo "" >> security-summary.md

        # ê° ë‹¨ê³„ë³„ ê²°ê³¼ ìš”ì•½
        echo "### ğŸ” Code Analysis" >> security-summary.md
        if [ -d "code-analysis-results" ]; then
          echo "âœ… Code analysis completed" >> security-summary.md
        else
          echo "âŒ Code analysis failed" >> security-summary.md
        fi
        echo "" >> security-summary.md

        echo "### ğŸ›¡ï¸ Security Scanning" >> security-summary.md
        if [ -d "security-reports" ]; then
          echo "âœ… Security scanning completed" >> security-summary.md
        else
          echo "âŒ Security scanning failed" >> security-summary.md
        fi
        echo "" >> security-summary.md

        echo "### ğŸ“„ License Compliance" >> security-summary.md
        if [ -d "license-reports" ]; then
          echo "âœ… License compliance checked" >> security-summary.md
        else
          echo "âŒ License compliance check failed" >> security-summary.md
        fi
        echo "" >> security-summary.md

        echo "### ğŸ—ï¸ Infrastructure Security" >> security-summary.md
        if [ -d "iac-security-reports" ]; then
          echo "âœ… Infrastructure security scanned" >> security-summary.md
        else
          echo "âŒ Infrastructure security scan failed" >> security-summary.md
        fi
        echo "" >> security-summary.md

        echo "### ğŸ”„ Supply Chain Security" >> security-summary.md
        if [ -d "supply-chain-reports" ]; then
          echo "âœ… Supply chain security verified" >> security-summary.md
        else
          echo "âŒ Supply chain security verification failed" >> security-summary.md
        fi
        echo "" >> security-summary.md

        echo "---" >> security-summary.md
        echo "*Generated on: $(date)*" >> security-summary.md

    - name: ğŸ“‹ Upload Security Summary
      uses: actions/upload-artifact@v3
      with:
        name: security-summary
        path: security-summary.md

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('security-summary.md', 'utf8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  # ğŸš¨ ë³´ì•ˆ ì•Œë¦¼
  security-alerts:
    name: ğŸš¨ Security Alerts
    runs-on: ubuntu-latest
    needs: security-summary
    if: failure() && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')

    steps:
    - name: ğŸ“§ Critical Security Alert
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#security-alerts'
        author_name: 'Security Pipeline'
        title: 'ğŸš¨ Critical Security Issues Detected'
        message: |
          Security vulnerabilities or compliance issues detected in ${{ github.repository }}

          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}

          Please review the security reports immediately.
        webhook_url: ${{ secrets.SECURITY_SLACK_WEBHOOK }}

    - name: ğŸ“§ Email Security Team
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "ğŸš¨ URGENT: Security Issues in ${{ github.repository }}"
        to: security@fragrance-ai.com
        from: security-pipeline@fragrance-ai.com
        body: |
          Critical security issues have been detected in the repository.

          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please investigate immediately and take appropriate action.

          This is an automated message from the security pipeline.